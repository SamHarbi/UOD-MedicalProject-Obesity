<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Import model-viewer component -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js">
  </script>

  <!-- Import Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />

  <!-- JavaScript Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous">
  </script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lexend&display=swap" rel="stylesheet"> 

  <!-- Switchery Import -->
  <link rel="stylesheet" href="Switchery-0.8.2/switchery.css" />
  <script src="Switchery-0.8.2/switchery.js"></script>

  <!--AR.js-->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <!--Icons--> 
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

  <!-- Import local CSS-->
  <link rel="stylesheet" href="CSS/style.css" />
  

</head>

<body id="body">

  <a id="menu" data-bs-toggle="collapse" data-bs-placement="top" href="#collapse"
    role="button" aria-expanded="false" aria-controls="collapse" onclick="showModel()">
    <h2><i class="bi bi-list"></i></h2>
  </a>

  <a class="play" id="menu" data-bs-placement="top" 
    role="button" onclick="animationControl()" style="top: 70%; background-image: 'Icons/play.svg'">
    <h2><i class="bi bi-play" id="controlButton"></i></h2>
  </a>


  <div class="collapse" id="collapse">

    <div class="card mb-3" >
      <div class="row g-0">
        <div class="col-md-4">
          <img src="..." class="img-fluid rounded-start" alt="...">
        </div>
        <div class="col-md-8">
          <div class="card-body">
            <h1>Heart and Lungs Under Stages of Obesity Visualiser</h1>
            <h5>A Cross Disciplinary Project undertaken by students at the University of Dundee to visualise the Anatomy
              changes that a person with obesity would have compared
              to a healthy person.
            </h5>
          </div>
        </div>
      </div>
    </div>

    <div class="card-group" >
      <div class="card">
        <div class="card-body">
          <p class="lead">Control Panel</p>
          <h5><input id="labelTick" type="checkbox" class="js-switch" checked /> Labels </h5>
          <h5><input type="checkbox" class="js-switch" checked /> Descriptions </h5>
          <h5><input type="checkbox" class="js-switch" checked /> Quiz </h5>
          <button type="button" class="btn btn-primary" onclick="showAR();" data-bs-toggle="collapse" href="#collapse">Marker AR</button>
          <button type="button" class="btn btn-primary">Credits</button>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <p class="lead">Accessibility Options</p>
          <p>Font Options</p>
          <button class="btn btn-primary" id="Lex" onclick="changeAccess('0')">Lexend</button> 
          <button class="btn btn-primary" id="Osa" onclick="changeAccess('2')">Times New Roman</button>
          <button class="btn btn-primary" id="Ody" onclick="changeAccess('1')">Open-Dyslexia</button>
          <p style="margin-top: 5%;">Font Sizing</p>
          <button class="btn btn-primary" id="Res" onclick="changeAccess('3')">Small Size</button> 
          <button class="btn btn-primary" id="Res" onclick="changeAccess('4')">Regular Size</button> 
          <button class="btn btn-primary" id="Lsi" onclick="changeAccess('5')">Large Size</button> 
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <p class="lead">Disease Intensity</p>
          <p>Change this value to see the progressive change that Obesity has on the Heart and Lungs from a relatively healthy person, to someone who is more Obese. These changes
            are based not on exact numbers or measurements but on typical changes that result from the Disease.
          </p>
          Healthy
          <input id="ObesitySlide" type="range" min="1" max="100" value="35" class="slider" style="width: 35%; position: relative;" oninput="switchModel(this.value);">
          <label for="ObesitySlide">Obese</label>
        </div>
      </div>
    </div>
    <div class="card" style="margin-bottom: 5%;">
      <div class="card-body">
        <p class="lead">Quiz</p>
        <p>This is a question, what do you think?</p>
        <p><input type="checkbox" id="Q1">
        <label for="Q1"> Answer 1 </label></p>
        <p><input type="checkbox" id="Q2">
        <label for="Q2"> Answer 2 </label></p>
        <p><input type="checkbox" id="Q3">
        <label for="Q3"> Answer 3 </label></p>
      </div>
    </div>
  </div>
  </div>
  </div>

  <div class="container-fluid g-0" style="margin: 0%;" id="model">
    <!-- 3D Model View -->
    <model-viewer alt="An Artistic Representation of a Heart" src="Models/Obese_heart_anim_final.glb" ar
      ar-modes="webxr scene-viewer quick-look" environment-image="" poster="" seamless-poster shadow-intensity="1"
      camera-controls style="background-color: #4A525A;" id="main" camera-target="0m 0m 0m" >

      <button class="label" slot="hotspot-spot" data-position="-0.70 1.2 0.1" data-normal="-0.73 0.05 0.69" id="button-model">
        <div id="annotation">Superior Vena Cava</div>
      </button>

      <button class="label" slot="hotspot" data-position="0.5 0 0" data-normal="0 0 0" id="button-model">
        <div id="annotation">Another Part - WIP </div>
      </button>

    </model-viewer>
  </div>

  <div class="container-fluid" id="ARview" style="height: 100%;">
    <iframe src="MarkerARPage/MarkerARPage.html" title="AR Camera View"></iframe>
  </div>

</body>



<script type="module">



  //Panning Code from Google Module Viewer Documentation 

  const modelViewer = document.querySelector('#main');
  const tapDistance = 2;
  let panning = false;
  let panX, panY;
  let startX, startY;
  let lastX, lastY;
  let metersPerPixel;

  const startPan = () => {
    const orbit = modelViewer.getCameraOrbit();
    const { theta, phi, radius } = orbit;
    const psi = theta - modelViewer.turntableRotation;
    metersPerPixel = 0.75 * radius / modelViewer.getBoundingClientRect().height;
    panX = [-Math.cos(psi), 0, Math.sin(psi)];
    panY = [
      -Math.cos(phi) * Math.sin(psi),
      Math.sin(phi),
      -Math.cos(phi) * Math.cos(psi)
    ];
    modelViewer.interactionPrompt = 'none';
  };

  const movePan = (thisX, thisY) => {
    const dx = (thisX - lastX) * metersPerPixel;
    const dy = (thisY - lastY) * metersPerPixel;
    lastX = thisX;
    lastY = thisY;

    const target = modelViewer.getCameraTarget();
    target.x += dx * panX[0] + dy * panY[0];
    target.y += dx * panX[1] + dy * panY[1];
    target.z += dx * panX[2] + dy * panY[2];
    modelViewer.cameraTarget = `${target.x}m ${target.y}m ${target.z}m`;

    // This pauses turntable rotation
    modelViewer.dispatchEvent(new CustomEvent(
      'camera-change', { detail: { source: 'user-interaction' } }));
  };

  const recenter = (pointer) => {
    panning = false;
    if (Math.abs(pointer.clientX - startX) > tapDistance ||
      Math.abs(pointer.clientY - startY) > tapDistance)
      return;
    const hit = modelViewer.positionAndNormalFromPoint(pointer.clientX, pointer.clientY);
    modelViewer.cameraTarget =
      hit == null ? 'auto auto auto' : hit.position.toString();
  };

  modelViewer.addEventListener('mousedown', (event) => {
    startX = event.clientX;
    startY = event.clientY;
    panning = event.button === 2 || event.ctrlKey || event.metaKey ||
      event.shiftKey;
    if (!panning)
      return;

    lastX = startX;
    lastY = startY;
    startPan();
    event.stopPropagation();
  }, true);

  modelViewer.addEventListener('touchstart', (event) => {
    const { targetTouches, touches } = event;
    startX = targetTouches[0].clientX;
    startY = targetTouches[0].clientY;
    panning = targetTouches.length === 2 && targetTouches.length === touches.length;
    if (!panning)
      return;

    lastX = 0.5 * (targetTouches[0].clientX + targetTouches[1].clientX);
    lastY = 0.5 * (targetTouches[0].clientY + targetTouches[1].clientY);
    startPan();
  }, true);

  self.addEventListener('mousemove', (event) => {
    if (!panning)
      return;

    movePan(event.clientX, event.clientY);
    event.stopPropagation();
  }, true);

  modelViewer.addEventListener('touchmove', (event) => {
    if (!panning || event.targetTouches.length !== 2)
      return;

    const { targetTouches } = event;
    const thisX = 0.5 * (targetTouches[0].clientX + targetTouches[1].clientX);
    const thisY = 0.5 * (targetTouches[0].clientY + targetTouches[1].clientY);
    movePan(thisX, thisY);
  }, true);

  self.addEventListener('mouseup', (event) => {
    recenter(event);
  }, true);

  modelViewer.addEventListener('touchend', (event) => {
    if (event.targetTouches.length === 0) {
      recenter(event.changedTouches[0]);

      if (event.cancelable) {
        event.preventDefault();
      }
    }
  }, true);

</script>

</html>

<!-- Import local Javascript-->
<script src="Scripts/localscripts.js" async></script>